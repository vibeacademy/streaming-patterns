# Verify Cloudflare Secrets Configuration
#
# This workflow verifies that required GitHub Secrets are configured correctly
# for Cloudflare Workers deployment. It runs manually via workflow_dispatch.
#
# Purpose:
# - Confirm CLOUDFLARE_API_TOKEN exists and is accessible
# - Confirm CLOUDFLARE_ACCOUNT_ID exists and is accessible
# - Test Wrangler authentication with the API token
#
# Usage:
# 1. Go to: https://github.com/vibeacademy/streaming-patterns/actions
# 2. Select "Verify Cloudflare Secrets" workflow
# 3. Click "Run workflow" button
# 4. Verify all steps pass (green checkmarks)
#
# Security:
# - Secrets are never echoed in plaintext
# - Only secret lengths are displayed (safe)
# - GitHub automatically masks secret values in logs
#
# Related Issue: #77
# Related Epic: #70 (GitHub Actions CI/CD Pipeline)

name: Verify Cloudflare Secrets

on:
  workflow_dispatch: # Manual trigger only

jobs:
  verify-secrets:
    name: Verify GitHub Secrets Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check CLOUDFLARE_API_TOKEN Exists
        run: |
          echo "Checking CLOUDFLARE_API_TOKEN..."
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "❌ CLOUDFLARE_API_TOKEN is not set"
            echo "::error::CLOUDFLARE_API_TOKEN secret is missing or empty"
            exit 1
          fi
          TOKEN_LENGTH=${#CLOUDFLARE_API_TOKEN}
          echo "✅ CLOUDFLARE_API_TOKEN is set (length: $TOKEN_LENGTH characters)"

          # Validate minimum length (Cloudflare tokens are typically 40+ characters)
          if [ $TOKEN_LENGTH -lt 40 ]; then
            echo "⚠️  WARNING: Token length seems short (expected 40+ characters)"
            echo "::warning::CLOUDFLARE_API_TOKEN length is $TOKEN_LENGTH (expected 40+)"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Check CLOUDFLARE_ACCOUNT_ID Exists
        run: |
          echo "Checking CLOUDFLARE_ACCOUNT_ID..."
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "❌ CLOUDFLARE_ACCOUNT_ID is not set"
            echo "::error::CLOUDFLARE_ACCOUNT_ID secret is missing or empty"
            exit 1
          fi
          ACCOUNT_ID_LENGTH=${#CLOUDFLARE_ACCOUNT_ID}
          echo "✅ CLOUDFLARE_ACCOUNT_ID is set (length: $ACCOUNT_ID_LENGTH characters)"

          # Validate length (Cloudflare Account IDs are 32 characters)
          if [ $ACCOUNT_ID_LENGTH -ne 32 ]; then
            echo "⚠️  WARNING: Account ID length is not 32 characters (got $ACCOUNT_ID_LENGTH)"
            echo "::warning::CLOUDFLARE_ACCOUNT_ID length is $ACCOUNT_ID_LENGTH (expected 32)"
          fi
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Wrangler CLI
        run: |
          echo "Installing wrangler..."
          npm install -g wrangler@latest
          wrangler --version

      - name: Test Wrangler Authentication
        run: |
          echo "Testing Wrangler authentication..."
          echo "Running: wrangler whoami"

          # Attempt to authenticate with Wrangler
          if wrangler whoami; then
            echo "✅ Wrangler authentication successful!"
            echo "API token has valid permissions"
          else
            echo "❌ Wrangler authentication failed"
            echo "::error::API token authentication failed - check token permissions"
            exit 1
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Verify Token Permissions (Optional)
        run: |
          echo "Token permissions cannot be directly verified via wrangler whoami"
          echo "Full permissions will be tested during actual deployment workflow"
          echo ""
          echo "Required permissions for CI/CD:"
          echo "  - Workers Scripts: Edit"
          echo "  - Account Settings: Read"
          echo "  - Workers Routes: Edit"
          echo "  - DNS: Edit (for custom domains)"
          echo ""
          echo "If deployment workflows fail, verify these permissions at:"
          echo "https://dash.cloudflare.com/profile/api-tokens"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Summary
        run: |
          echo "=================================================="
          echo "✅ Secrets Verification Complete"
          echo "=================================================="
          echo ""
          echo "All required secrets are configured correctly:"
          echo "  ✅ CLOUDFLARE_API_TOKEN - exists and authenticates"
          echo "  ✅ CLOUDFLARE_ACCOUNT_ID - exists with correct format"
          echo ""
          echo "Next steps:"
          echo "  1. Implement GitHub Actions deployment workflows"
          echo "  2. Test production deployment workflow"
          echo "  3. Test preview environment workflow"
          echo ""
          echo "See: docs/CLOUDFLARE-DEPLOYMENT.md for workflow examples"
