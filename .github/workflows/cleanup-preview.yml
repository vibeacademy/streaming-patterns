name: Cleanup Preview Environment

on:
  pull_request:
    types: [closed]

# Ensures only one cleanup runs per PR
concurrency:
  group: preview-cleanup-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  cleanup-preview:
    name: Cleanup Preview (pr-${{ github.event.pull_request.number }})
    runs-on: ubuntu-latest

    # Set permissions for PR comments
    permissions:
      contents: read
      pull-requests: write

    steps:
      # 1. Extract PR number and construct Worker name
      - name: Set environment variables
        id: vars
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          WORKER_NAME="streaming-patterns-pr-${PR_NUMBER}"

          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "worker_name=${WORKER_NAME}" >> $GITHUB_OUTPUT
          echo "ðŸ“ PR Number: ${PR_NUMBER}"
          echo "ðŸ”§ Worker Name: ${WORKER_NAME}"

      # 2. Setup Node.js (required for wrangler)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      # 3. Install wrangler globally
      - name: Install wrangler
        run: npm install -g wrangler

      # 4. Delete Cloudflare Worker
      - name: Delete preview Worker
        id: delete
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          WORKER_NAME="${{ steps.vars.outputs.worker_name }}"

          echo "ðŸ—‘ï¸ Attempting to delete Worker: ${WORKER_NAME}"

          # Use wrangler delete with --force flag to skip confirmation
          # Capture output and exit code
          if OUTPUT=$(wrangler delete --name "${WORKER_NAME}" --force 2>&1); then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Worker deleted successfully" >> $GITHUB_OUTPUT
            echo "âœ… Worker deleted successfully"
            echo "${OUTPUT}"
          else
            EXIT_CODE=$?
            echo "${OUTPUT}"

            # Check if error is because Worker doesn't exist (expected case)
            if echo "${OUTPUT}" | grep -qi "not found\|does not exist\|couldn't find"; then
              echo "status=not_found" >> $GITHUB_OUTPUT
              echo "message=Worker not found (likely already deleted)" >> $GITHUB_OUTPUT
              echo "ðŸ’¡ Worker not found - likely already deleted or never existed"
              echo "âœ… This is expected and not an error"
            else
              # Actual failure - fail the workflow
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "message=Worker deletion failed (exit code: ${EXIT_CODE})" >> $GITHUB_OUTPUT
              echo "::error::âŒ Worker deletion failed with exit code ${EXIT_CODE}"
              echo "::error::Worker: ${WORKER_NAME}"
              echo "::error::This indicates a real failure that needs investigation"
              exit ${EXIT_CODE}
            fi
          fi

      # 5. Find existing preview comment
      - name: Find existing preview comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## ðŸš€ Preview Deployment'

      # 6. Update preview comment with cleanup status
      - name: Update preview comment with cleanup status
        if: steps.find-comment.outputs.comment-id != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          edit-mode: append
          body: |

            ---

            ## ðŸ—‘ï¸ Preview Cleanup

            Preview environment has been cleaned up.

            - **Worker**: `${{ steps.vars.outputs.worker_name }}`
            - **Status**: ${{ steps.delete.outputs.status == 'success' && 'âœ… Deleted' || (steps.delete.outputs.status == 'not_found' && 'ðŸ’¡ Not found (already deleted)' || 'âŒ Failed') }}
            - **Preview URL**: No longer accessible
            - **Details**: ${{ steps.delete.outputs.message }}

            ðŸ¤– Cleaned up at $(date -u +"%Y-%m-%d %H:%M:%S UTC")

      # 7. Post new cleanup comment (if no preview comment found)
      - name: Post cleanup status comment
        if: steps.find-comment.outputs.comment-id == ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ðŸ—‘ï¸ Preview Cleanup

            Preview environment cleanup attempted.

            - **Worker**: `${{ steps.vars.outputs.worker_name }}`
            - **Status**: ${{ steps.delete.outputs.status == 'success' && 'âœ… Deleted' || (steps.delete.outputs.status == 'not_found' && 'ðŸ’¡ Not found (already deleted)' || 'âŒ Failed') }}
            - **Details**: ${{ steps.delete.outputs.message }}

            ---

            ðŸ¤– Cleaned up at $(date -u +"%Y-%m-%d %H:%M:%S UTC")

      # 8. Post cleanup success notification
      - name: Post cleanup success notification
        if: steps.delete.outputs.status == 'success'
        run: |
          echo "âœ… Preview cleanup successful!"
          echo "ðŸ—‘ï¸ Worker deleted: ${{ steps.vars.outputs.worker_name }}"
          echo "ðŸ’¬ PR comment updated with cleanup status"

      # 9. Post cleanup not-found notification
      - name: Post cleanup not-found notification
        if: steps.delete.outputs.status == 'not_found'
        run: |
          echo "ðŸ’¡ Preview Worker not found"
          echo "ðŸ—‘ï¸ Worker: ${{ steps.vars.outputs.worker_name }}"
          echo "âœ… This is expected if the Worker was already deleted or never existed"
          echo "ðŸ’¬ PR comment updated with cleanup status"

      # 10. Workflow summary
      - name: Workflow summary
        if: always()
        run: |
          echo "## ðŸ—‘ï¸ Preview Cleanup Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Worker**: \`${{ steps.vars.outputs.worker_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.delete.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Message**: ${{ steps.delete.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.delete.outputs.status }}" = "success" ]; then
            echo "âœ… **Result**: Worker successfully deleted" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.delete.outputs.status }}" = "not_found" ]; then
            echo "ðŸ’¡ **Result**: Worker not found (expected)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Result**: Cleanup failed - requires investigation" >> $GITHUB_STEP_SUMMARY
          fi
